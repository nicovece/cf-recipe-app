{% extends 'base.html' %}
{% load recipe_extras %}


{% block title %}Recipe Search - Nomalyze{% endblock %}

{% block extra_css %}
<style>
    .search-results-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }

    .search-results-table th,
    .search-results-table td {
        border: 1px solid #e5e7eb;
        padding: 12px;
        text-align: left;
    }

    .search-results-table th {
        background-color: #f9fafb;
        font-weight: 600;
        color: #374151;
    }

    .search-results-table tr:nth-child(even) {
        background-color: #f9fafb;
    }

    .search-results-table tr:hover {
        background-color: #f3f4f6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container px-6 pt-20 pb-20 mx-auto mb-12">
    <h1 class="mt-12 mb-8 font-serif text-2xl font-bold text-accent-600 text-primary-400">
        Search Recipes & Analyze Data
    </h1>
    <div class="grid grid-cols-1 lg:grid-cols-[80%_20%] lg:grid-rows-[auto_auto]">
        <!-- Search Form -->
        <div class="p-4 pb-12 mb-8 rounded-lg shadow-lg md:p-8 bg-alternate_a-100/50">
            <h2 class="mb-4 text-xl font-semibold text-accent-600">Search Criteria</h2>
            <form action="" method="POST">
                {% csrf_token %}
                <div class="grid grid-cols-1 gap-10 md:grid-cols-2">
                    <div>
                        <label for="{{ form.recipe_name.id_for_label }}"
                            class="block mb-1 text-sm font-medium text-gray-700">
                            Recipe Name
                        </label>
                        {{ form.recipe_name|tailwind_input }}
                        {% if form.recipe_name.help_text %}
                        <p class="mt-1 text-xs text-gray-500">{{ form.recipe_name.help_text }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label for="{{ form.ingredients.id_for_label }}"
                            class="block mb-1 text-sm font-medium text-gray-700">
                            Ingredients
                        </label>
                        {{ form.ingredients|tailwind_input }}
                        {% if form.ingredients.help_text %}
                        <p class="mt-1 text-xs text-gray-500">{{ form.ingredients.help_text }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label for="{{ form.cooking_time_max.id_for_label }}"
                            class="block mb-1 text-sm font-medium text-gray-700">
                            Max Cooking Time (minutes)
                        </label>
                        {{ form.cooking_time_max|tailwind_input }}
                    </div>

                    <div>
                        <label for="{{ form.difficulty.id_for_label }}"
                            class="block mb-1 text-sm font-medium text-gray-700">
                            Difficulty Level
                        </label>
                        {{ form.difficulty|tailwind_input }}
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-4 mt-12 grid-rows-auto md:grid-cols-3">
                    <div class="md:row-start-1">
                        <button type="submit" name="search_action" value="search"
                            class="px-6 py-3 w-full font-bold text-white rounded-lg transition-all duration-300 bg-accent-400 hover:bg-accent-600 hover:scale-105">
                            Search & Analyze
                        </button>
                        <div class="mt-2 text-xs text-center text-gray-600">
                            <p>Use the form fields above to filter recipes</p>
                        </div>
                    </div>
                    <hr class="my-2 border-dashed md:col-span-2 md:row-start-2 border-alternate_a-200">
                    <div class="md:row-start-3">
                        <button type="submit" name="search_action" value="show_all"
                            class="px-6 py-3 font-bold bg-transparent rounded-lg border border-solid transition-all duration-300 !border-accent-600 text-accent-600 hover:bg-accent-400 hover:text-white hover:border-accent-600 w-full">
                            Analyze All Recipes!</button>
                        <div class="mt-2 text-xs text-center text-gray-600">
                            <p>Generate analysis for all recipes in the database</p>
                        </div>
                    </div>
                    <div class="md:row-start-3">
                        <a href="{% url 'recipes:recipe-list' %}"
                            class="block px-6 py-3 font-bold bg-transparent rounded-lg border border-solid transition-all duration-300 !border-accent-600 text-accent-600 hover:bg-accent-400 hover:text-white hover:border-accent-600 w-full text-center">
                            Browse all Recipes</a>
                        <div class="mt-2 text-xs text-center text-gray-600">
                            <p>Browse all recipes in the database</p>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <!-- No Results Message -->
        {% if not recipes and request.method == "POST" or not recipes and "search_form_data" in request.session %}
        <div class="p-10 mt-8 mb-12 bg-yellow-100 rounded-lg border border-yellow-200 lg:row-start-2 lg:mb-0"
            id="no-recipes-found">
            <h3 class="mb-2 text-xl font-semibold text-yellow-800">No Recipes Found</h3>
            <p class="text-lg text-yellow-700">Try adjusting your search criteria or <a
                    href="{% url 'recipes:recipe-list' %}" class="text-accent-600 hover:underline">view all recipes</a>.
            </p>
        </div>
        {% endif %}
        <!-- Instructions -->
        <div class="text-xs text-gray-500/75 lg:pl-6">
            <h3 class="mb-2 text-sm font-semibold">Search Tips</h3>
            <ul class="grid grid-cols-1 gap-y-0 gap-2 space-y-3 list-none sm:grid-cols-3 lg:grid-cols-1">
                <li class="{% search_tip_classes %}"><strong>Partial matching:</strong><br>
                    "pasta" will find
                    "Pasta al Pesto"</li>
                <li class="{% search_tip_classes %}"><strong>Wildcard *:</strong><br> "pasta*"
                    finds "pasta", "pastas", "pasta-based"</li>
                <li class="{% search_tip_classes %}"><strong>Wildcard ?:</strong><br> "pasta?"
                    finds "pasta" but not "pastas"</li>
                <li class="{% search_tip_classes %}"><strong>Multiple ingredients:</strong><br>
                    Enter "tomato*, cheese" to find recipes containing ALL specified ingredients</li>
                <li class="{% search_tip_classes %}"><strong>Time filtering:</strong><br> Enter 10
                    to find recipes taking 10 minutes or less</li>
                <li class="{% search_tip_classes %}"><strong>Show all:</strong><br> Leave fields
                    empty to see all recipes</li>
            </ul>
        </div>
    </div>
    <!-- Search Results -->
    {% if recipes %}
    <div class="pt-28 mb-12" id="search-results">
        <h2 class="mb-4 text-xl font-semibold text-accent-600">Search Results</h2>
        <div class="grid grid-cols-1 gap-10 sm:grid-cols-2 lg:grid-cols-1">
            {% for recipe in recipes %}
            <div
                class="flex overflow-hidden flex-col p-0 w-full max-w-sm bg-white rounded-lg shadow-lg transition-all ease-out lg:grid lg:grid-cols-[30%_30%_20%_20%] lg:max-w-full recipe-card hover:scale-105 hover:shadow-xl border border-alternate_a-100">
                <!-- First Row: Image and Main Content -->
                <div class="w-full-">
                    <a href="{{ recipe.detail_url }}" class=""><img src="{{ recipe.recipe_image_url }}"
                            alt="Summer salad" class="object-cover w-full h-full aspect-[6/3]">
                    </a>
                </div>
                <div class="flex flex-col p-6">
                    <h2 class="mb-1 font-serif text-2xl font-bold text-accent-600 text-primary-400"><a
                            href="{{ recipe.detail_url }}"
                            class="block mb-1 font-semibold text-accent-600 hover:text-accent-800">
                            {{ recipe.name }}
                        </a>
                    </h2>
                    <p class="text-sm text-gray-600">
                        {{ recipe.short_description }}
                    </p>
                    <!-- <p class="text-sm text-gray-600">Hard</p>
                    <p class="text-sm text-gray-600">15 minutes</p> -->
                    <a href="{{ recipe.detail_url }}"
                        class="px-4 py-2 mt-4 w-max text-sm font-bold rounded-md transition-all duration-300 text-accent-600 bg-alternate_a-100 hover:text-white hover:bg-accent-400">View
                        Recipe</a>
                </div>
                <div class="px-4 py-3 mx-3 my-6 rounded-lg border border-dashed border-alternate_a-200">
                    <h2 class="mb-4 text-base text-accent-600">Ingredients: <span class="ml-1 font-bold">
                            {{ recipe.ingredient_count }}
                        </span></h2>
                    <ul class="space-y-2">
                        {% for ingredient in recipe.ingredients|split:',' %}
                        <li class="flex items-center text-sm text-gray-700">
                            <svg class="mr-3 w-4 h-4 text-alternate_a-300" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            {{ ingredient }}
                        </li>
                        {% endfor %}

                    </ul>
                </div>
                <div
                    class="flex flex-col px-2 py-3 mx-3 my-6 mr-6 rounded-lg border border-dashed border-alternate_a-200">
                    <div class="flex gap-2 items-center p-2">
                        <div class="w-3 h-3 rounded-full bg-alternate_a-300"></div>
                        <div class="text-sm text-gray-600">Total time: <strong class="text-accent-600">
                                {{ recipe.cooking_time }} minutes</strong>
                        </div>
                    </div>
                    <div class="flex gap-2 items-center p-2">
                        <div class="w-3 h-3 rounded-full bg-alternate_a-300"></div>
                        <div class="text-sm text-gray-600">Difficulty: <strong class="text-accent-600">
                                {{ recipe.difficulty }}</strong>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Charts Display -->
    {% if charts %}
    <div class="my-24">
        <h2 class="mb-6 text-xl font-semibold text-accent-600" id="data-visualizations">Data Visualizations</h2>

        <!-- Bar Chart -->
        <div class="pt-8 my-8 border-t border-dashed border-alternate_a-200">
            <h3 class="mb-4 text-lg font-medium text-accent-800">Recipe Cooking Times</h3>
            <div class="p-6 text-center bg-white rounded-lg shadow-lg">
                <img src="data:image/png;base64, {{ charts.bar|safe }}" alt="Recipe Cooking Times Bar Chart"
                    class="mx-auto max-w-full h-auto">
            </div>
        </div>

        <!-- Pie Chart -->
        <div class="mb-8">
            <h3 class="mb-4 text-lg font-medium text-accent-800">Difficulty Level Distribution</h3>
            <div class="p-6 text-center bg-white rounded-lg shadow-lg">
                <img src="data:image/png;base64, {{ charts.pie|safe }}" alt="Recipe Difficulty Distribution Pie Chart"
                    class="mx-auto max-w-full h-auto">
            </div>
        </div>

        <!-- Line Chart -->
        <div class="mb-8">
            <h3 class="mb-4 text-lg font-medium text-accent-800">Cooking Time vs Number of Ingredients</h3>
            <div class="p-6 text-center bg-white rounded-lg shadow-lg">
                <img src="data:image/png;base64, {{ charts.line|safe }}" alt="Cooking Time vs Ingredients Line Chart"
                    class="mx-auto max-w-full h-auto">
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}